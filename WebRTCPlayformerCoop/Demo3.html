<!DOCTYPE html>
<html>
<head>
    <title>WebGL Co-op Platformer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* UI Panel */
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #menu { background: rgba(0,0,0,0.9); padding: 20px; border-radius: 12px; pointer-events: auto; max-width: 90%; width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center; }
        
        h1 { margin: 0 0 10px 0; font-size: 20px; color: #4CAF50; }
        p { font-size: 14px; color: #ccc; margin: 5px 0; }
        
        /* Inputs & Buttons */
        textarea { width: 100%; height: 60px; margin: 10px 0; background: #333; color: #0f0; border: 1px solid #555; font-size: 10px; border-radius: 4px; padding: 5px; resize: none; }
        
        .btn { padding: 10px 15px; cursor: pointer; background: #4CAF50; border: none; color: white; border-radius: 6px; font-size: 14px; font-weight: bold; width: 100%; margin-bottom: 5px; }
        .btn:disabled { background: #555; cursor: wait; opacity: 0.7; }
        .btn-blue { background: #2196F3; }
        .btn-copy { background: #ff9800; font-size: 12px; padding: 5px; margin-bottom: 10px; }
        
        .status { font-weight: bold; color: #ffeb3b; margin: 10px 0; font-size: 14px; border: 1px dashed #555; padding: 5px; }
        .hidden { display: none !important; }

        /* TOUCH CONTROLS */
        #touch-controls { position: absolute; bottom: 20px; left: 0; width: 100%; height: 120px; pointer-events: none; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; z-index: 20; }
        .control-group { pointer-events: auto; display: flex; gap: 20px; align-items: flex-end; }
        .touch-btn { width: 70px; height: 70px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; user-select: none; -webkit-user-select: none; backdrop-filter: blur(4px); }
        .touch-btn:active, .touch-btn.active { background: rgba(76, 175, 80, 0.5); transform: scale(0.95); border-color: #4CAF50; }
    </style>
</head>
<body>

<div id="ui">
    <div id="menu">
        <h1>WebGL Co-op</h1>
        <div id="status" class="status">Mode: Offline (Single Player)</div>

        <div id="step1">
            <p><b>1. Host Game (Player 1)</b></p>
            <button class="btn" onclick="net.createOffer()">Start Hosting</button>
        </div>

        <div id="step2" class="hidden">
            <p><b>Send this code to Player 2:</b></p>
            <textarea id="localSdp" readonly placeholder="Generating code... please wait..."></textarea>
            <button class="btn btn-copy" onclick="copyToClipboard('localSdp')">üìã Copy Code</button>
            <p style="font-size:12px; color:#888;">Wait until text appears above before copying!</p>
            <hr style="border-color:#444">
            <p><b>Paste Player 2's Reply Here:</b></p>
            <textarea id="remoteSdpHost" placeholder="Paste the code from Player 2 here"></textarea>
            <button class="btn btn-blue" onclick="net.acceptAnswer()">3. Connect</button>
        </div>

        <div id="stepJoin" class="hidden">
            <p><b>Paste Player 1's Code Here:</b></p>
            <textarea id="remoteSdpJoin" placeholder="Paste Host code here"></textarea>
            <button class="btn btn-blue" onclick="net.acceptOffer()">2. Join Game</button>
            <div id="joinOutput" class="hidden">
                <p><b>Send this reply to Player 1:</b></p>
                <textarea id="localSdpJoin" readonly placeholder="Generating reply..."></textarea>
                <button class="btn btn-copy" onclick="copyToClipboard('localSdpJoin')">üìã Copy Reply</button>
            </div>
        </div>
        
        <div style="margin-top:15px; border-top:1px solid #444; padding-top:10px;">
            <button class="btn" style="background:#444; font-size:12px;" onclick="showJoinerUI()">I am Player 2 (Join)</button>
        </div>
    </div>
</div>

<div id="touch-controls">
    <div class="control-group">
        <div class="touch-btn" id="t-left">‚Üê</div>
        <div class="touch-btn" id="t-right">‚Üí</div>
    </div>
    <div class="control-group">
        <div class="touch-btn" id="t-jump">‚Üë</div>
    </div>
</div>

<canvas id="glcanvas"></canvas>

<script id="vs" type="x-shader/x-vertex">
    attribute vec2 a_position;
    uniform vec2 u_resolution;
    uniform vec2 u_translation;
    uniform vec2 u_scale;
    uniform vec4 u_color;
    varying vec4 v_color;
    void main() {
        vec2 position = (a_position * u_scale) + u_translation;
        vec2 zeroToOne = position / u_resolution;
        vec2 zeroToTwo = zeroToOne * 2.0;
        vec2 clipSpace = zeroToTwo - 1.0;
        gl_Position = vec4(clipSpace * vec2(1, 1), 0, 1);
        v_color = u_color;
    }
</script>
<script id="fs" type="x-shader/x-fragment">
    precision mediump float;
    varying vec4 v_color;
    void main() { gl_FragColor = v_color; }
</script>

<script>
/* =========================================
   UI HELPERS
   ========================================= */
function showJoinerUI() {
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('stepJoin').classList.remove('hidden');
}

function copyToClipboard(id) {
    const el = document.getElementById(id);
    el.select();
    el.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(el.value).then(() => {
        alert("Copied to clipboard!");
    });
}

function setStatus(msg) {
    document.getElementById('status').innerText = msg;
}

/* =========================================
   1. WEBGL RENDERER
   ========================================= */
const canvas = document.getElementById("glcanvas");
const gl = canvas.getContext("webgl");

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    gl.viewport(0, 0, canvas.width, canvas.height);
}
window.addEventListener('resize', resize);
resize();

function createShader(gl, type, source) {
    const shader = gl.createShader(type);
    gl.shaderSource(shader, source);
    gl.compileShader(shader);
    return shader;
}

const program = gl.createProgram();
gl.attachShader(program, createShader(gl, gl.VERTEX_SHADER, document.getElementById("vs").text));
gl.attachShader(program, createShader(gl, gl.FRAGMENT_SHADER, document.getElementById("fs").text));
gl.linkProgram(program);

const positionLoc = gl.getAttribLocation(program, "a_position");
const resLoc = gl.getUniformLocation(program, "u_resolution");
const transLoc = gl.getUniformLocation(program, "u_translation");
const scaleLoc = gl.getUniformLocation(program, "u_scale");
const colorLoc = gl.getUniformLocation(program, "u_color");

const positionBuffer = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0,0, 1,0, 0,1, 0,1, 1,0, 1,1]), gl.STATIC_DRAW);

function drawRect(x, y, width, height, color) {
    gl.useProgram(program);
    gl.enableVertexAttribArray(positionLoc);
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
    gl.vertexAttribPointer(positionLoc, 2, gl.FLOAT, false, 0, 0);
    gl.uniform2f(resLoc, gl.canvas.width, gl.canvas.height);
    gl.uniform2f(transLoc, x, y);
    gl.uniform2f(scaleLoc, width, height);
    gl.uniform4f(colorLoc, color[0], color[1], color[2], 1);
    gl.drawArrays(gl.TRIANGLES, 0, 6);
}

/* =========================================
   2. GAME LOGIC
   ========================================= */
const GRAVITY = 0.6;
const JUMP_FORCE = -12;
const SPEED = 5;

const gameState = {
    players: [
        { id: 0, x: 100, y: 300, w: 40, h: 40, vx: 0, vy: 0, color: [1, 0.2, 0.2], grounded: false },
        { id: 1, x: 200, y: 300, w: 40, h: 40, vx: 0, vy: 0, color: [0.2, 0.5, 1], grounded: false }
    ],
    platforms: [
        { x: 0, y: 550, w: 2000, h: 50 },
        { x: 300, y: 400, w: 200, h: 20 },
        { x: 600, y: 300, w: 200, h: 20 },
        { x: 100, y: 200, w: 150, h: 20 }
    ]
};

const input = { local: { left:false, right:false, up:false }, remote: { left:false, right:false, up:false } };

function updatePhysics() {
    if (net.isClient && net.connected) return; // Client waits for state
    
    gameState.players.forEach((p, index) => {
        let keys = (index === 0) ? input.local : input.remote;
        if(net.isClient) keys = (index === 1) ? input.local : input.remote; // Fallback if logic flipped
        
        if (keys.left) p.vx = -SPEED;
        else if (keys.right) p.vx = SPEED;
        else p.vx = 0;

        if (keys.up && p.grounded) { p.vy = JUMP_FORCE; p.grounded = false; }
        
        p.vy += GRAVITY;
        p.x += p.vx;
        p.y += p.vy;
        
        // Floor Collision
        p.grounded = false;
        gameState.platforms.forEach(plat => {
            if (p.x < plat.x + plat.w && p.x + p.w > plat.x && p.y < plat.y + plat.h && p.y + p.h > plat.y) {
                if (p.vy > 0 && p.y + p.h - p.vy <= plat.y) {
                    p.y = plat.y - p.h; p.vy = 0; p.grounded = true;
                }
            }
        });
        if(p.y > 1000) { p.x = 100; p.y = 100; p.vy = 0; }
    });
}

/* =========================================
   3. NETWORKING
   ========================================= */
const net = {
    pc: null, dc: null, isHost: false, isClient: false, connected: false,

    setup: function() {
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };
        this.pc = new RTCPeerConnection(config);

        this.pc.onicecandidate = e => {
            if (e.candidate) {
                console.log("Gathering candidate...");
            } else {
                // Done gathering
                const sdp = JSON.stringify(this.pc.localDescription);
                if (this.isHost) document.getElementById('localSdp').value = sdp;
                else document.getElementById('localSdpJoin').value = sdp;
                setStatus("Code Generated! Please Copy.");
            }
        };

        this.pc.onconnectionstatechange = () => {
            console.log("Connection State:", this.pc.connectionState);
            if(this.pc.connectionState === 'connected') {
                setStatus("PEER CONNECTED! Game Starting...");
                setTimeout(() => document.getElementById('menu').classList.add('hidden'), 1000);
            }
        };

        this.pc.ondatachannel = e => { this.dc = e.channel; this.setupDataChannel(); };
    },

    createOffer: function() {
        this.isHost = true;
        this.setup();
        this.dc = this.pc.createDataChannel("game");
        this.setupDataChannel();
        
        this.pc.createOffer().then(d => this.pc.setLocalDescription(d));
        
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        setStatus("Gathering Candidates... Wait for text.");
    },

    acceptOffer: function() {
        const remoteText = document.getElementById('remoteSdpJoin').value;
        if(!remoteText) return alert("Please paste the Host Code first!");
        
        try {
            const offer = JSON.parse(remoteText);
            this.isClient = true;
            this.setup();
            this.pc.setRemoteDescription(offer)
                .then(() => this.pc.createAnswer())
                .then(d => this.pc.setLocalDescription(d));
            
            document.getElementById('joinOutput').classList.remove('hidden');
            setStatus("Gathering Reply... Wait for text.");
        } catch(e) { alert("Invalid Code! Make sure you copied the whole thing."); }
    },

    acceptAnswer: function() {
        const remoteText = document.getElementById('remoteSdpHost').value;
        if(!remoteText) return alert("Please paste the Joiner's Reply first!");
        
        try {
            const answer = JSON.parse(remoteText);
            this.pc.setRemoteDescription(answer);
            setStatus("Connecting... Please wait.");
        } catch(e) { alert("Invalid Reply Code!"); }
    },

    setupDataChannel: function() {
        this.dc.onopen = () => {
            this.connected = true;
            setStatus("DATA OPEN! Game Live.");
            document.getElementById('menu').classList.add('hidden');
        };
        this.dc.onmessage = e => {
            const data = JSON.parse(e.data);
            if (this.isHost && data.type === 'input') input.remote = data.keys;
            if (!this.isHost && data.type === 'state') {
                gameState.players[0] = data.p1;
                gameState.players[1] = data.p2;
            }
        };
    },

    send: function(data) {
        if (this.connected && this.dc.readyState === "open") this.dc.send(JSON.stringify(data));
    }
};

/* =========================================
   4. CONTROLS
   ========================================= */
window.addEventListener('keydown', e => handleKey(e.code, true));
window.addEventListener('keyup', e => handleKey(e.code, false));
function handleKey(code, isDown) {
    if (code === "ArrowLeft" || code === "KeyA") input.local.left = isDown;
    if (code === "ArrowRight" || code === "KeyD") input.local.right = isDown;
    if (code === "ArrowUp" || code === "KeyW") input.local.up = isDown;
}

function bindTouch(id, key) {
    const el = document.getElementById(id);
    const set = (active) => {
        input.local[key] = active;
        if(active) el.classList.add('active'); else el.classList.remove('active');
    };
    el.addEventListener('touchstart', e => { e.preventDefault(); set(true); });
    el.addEventListener('touchend', e => { e.preventDefault(); set(false); });
}
bindTouch('t-left', 'left');
bindTouch('t-right', 'right');
bindTouch('t-jump', 'up');

/* =========================================
   5. LOOP
   ========================================= */
function loop() {
    if (net.isHost || !net.connected) updatePhysics();
    
    if (net.connected) {
        if (net.isHost) net.send({ type: 'state', p1: gameState.players[0], p2: gameState.players[1] });
        else net.send({ type: 'input', keys: input.local });
    }

    gl.clearColor(0.2, 0.2, 0.2, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);

    gameState.platforms.forEach(p => drawRect(p.x, p.y, p.w, p.h, [0.5, 0.5, 0.5]));
    gameState.players.forEach(p => drawRect(p.x, p.y, p.w, p.h, p.color));

    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
