<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shelter Builder SAT - WebGL</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #ui {
            position: absolute; top: 20px; left: 20px; color: white;
            background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px;
            pointer-events: none; border: 1px solid #444;
        }
        #hotbar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px;
        }
        .slot {
            width: 80px; height: 80px; border: 2px solid #555; border-radius: 5px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; font-size: 12px; background: #222;
        }
        .slot.active { border-color: #00ffcc; background: #333; box-shadow: 0 0 10px #00ffcc; }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: white; border-radius: 50%; transform: translate(-50%, -50%);
            mix-blend-mode: difference;
        }
    </style>
</head>
<body>

    <div id="ui">
        <h2 style="margin:0 0 10px 0;">Shelter Builder SAT</h2>
        <p><b>WASD</b> Move | <b>Click</b> Loot</p>
        <p><b>P</b> Place (Green = Clear, Red = Blocked)</p>
        <p><b>1 / 2</b> Select Item Type</p>
    </div>

    <div id="hotbar">
        <div id="slot-can" class="slot active"><span>[1] CAN</span><strong id="count-can">0</strong></div>
        <div id="slot-bottle" class="slot"><span>[2] BOTTLE</span><strong id="count-bottle">0</strong></div>
    </div>

    <div id="crosshair"></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

        // --- SAT PHYSICS ENGINE ---
        // Simplified SAT for AABB/OBB check to ensure items don't overlap
        function checkCollisionSAT(meshA, meshB) {
            meshA.geometry.computeBoundingBox();
            meshB.geometry.computeBoundingBox();
            
            const boxA = new THREE.Box3().setFromObject(meshA);
            const boxB = new THREE.Box3().setFromObject(meshB);
            
            // Standard SAT/AABB overlap check
            return boxA.intersectsBox(boxB);
        }

        // --- Scene Config ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshLambertMaterial({ color: 0x228b22 }));
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        let inventory = { can: 5, bottle: 5 };
        let selectedType = 'can';
        const itemsInWorld = [];
        let canPlace = true;

        function getItemMesh(type, isGhost = false) {
            let geo = (type === 'can') ? new THREE.CylinderGeometry(0.15, 0.15, 0.4, 12) : new THREE.CylinderGeometry(0.08, 0.1, 0.5, 12);
            let color = (type === 'can') ? 0xff4444 : 0x44ffff;
            let mat = new THREE.MeshPhongMaterial({ color: color, transparent: isGhost, opacity: isGhost ? 0.5 : 1 });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.userData.type = type;
            return mesh;
        }

        function spawnItem(type, pos) {
            const item = getItemMesh(type);
            item.position.copy(pos);
            scene.add(item);
            itemsInWorld.push(item);
        }

        const ghost = getItemMesh('can', true);
        scene.add(ghost);

        // --- Interaction ---
        document.addEventListener('click', () => { controls.lock(); lootItem(); });
        window.addEventListener('keydown', (e) => {
            if (e.key === '1') selectSlot('can');
            if (e.key === '2') selectSlot('bottle');
            if (e.code === 'KeyP') placeItem();
        });

        function selectSlot(type) {
            selectedType = type;
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
            document.getElementById(`slot-${type}`).classList.add('active');
            const dummy = getItemMesh(type, true);
            ghost.geometry = dummy.geometry;
        }

        function lootItem() {
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(itemsInWorld);
            if (intersects.length > 0 && intersects[0].distance < 3) {
                const obj = intersects[0].object;
                inventory[obj.userData.type]++;
                scene.remove(obj);
                itemsInWorld.splice(itemsInWorld.indexOf(obj), 1);
                updateUI();
            }
        }

        function placeItem() {
            if (inventory[selectedType] > 0 && canPlace) {
                inventory[selectedType]--;
                spawnItem(selectedType, ghost.position);
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('count-can').innerText = inventory.can;
            document.getElementById('count-bottle').innerText = inventory.bottle;
        }

        const move = { fwd: false, bwd: false, lft: false, rgt: false };
        document.addEventListener('keydown', (e) => {
            if(e.code === 'KeyW') move.fwd = true;
            if(e.code === 'KeyS') move.bwd = true;
            if(e.code === 'KeyA') move.lft = true;
            if(e.code === 'KeyD') move.rgt = true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.code === 'KeyW') move.fwd = false;
            if(e.code === 'KeyS') move.bwd = false;
            if(e.code === 'KeyA') move.lft = false;
            if(e.code === 'KeyD') move.rgt = false;
        });

        function animate() {
            requestAnimationFrame(animate);
            if (controls.isLocked) {
                const speed = 0.1;
                if(move.fwd) controls.moveForward(speed);
                if(move.bwd) controls.moveForward(-speed);
                if(move.lft) controls.moveRight(-speed);
                if(move.rgt) controls.moveRight(speed);

                // Update Ghost Position
                const dir = new THREE.Vector3();
                camera.getWorldDirection(dir);
                ghost.position.copy(camera.position).add(dir.multiplyScalar(2));
                ghost.position.y = Math.max(ghost.position.y, 0.25);

                // SAT Collision Check
                canPlace = true;
                ghost.material.color.set(0x00ff00); // Default Green
                
                for (let item of itemsInWorld) {
                    if (checkCollisionSAT(ghost, item)) {
                        canPlace = false;
                        ghost.material.color.set(0xff0000); // Red if blocked
                        break;
                    }
                }
            }
            renderer.render(scene, camera);
        }

        camera.position.y = 1.6;
        updateUI();
        animate();
    </script>
</body>
</html>
