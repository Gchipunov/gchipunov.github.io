<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CrimeWars - Live Construction Sandbox</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        canvas { display: block; }
    </style>
</head>
<body>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';

    // --- Configuration ---
    const CITY_SIZE = 500;
    const MAX_BUILDINGS = 20;
    const CONSTRUCTION_SPEED = 0.2; // Buildings per second

    // --- Shaders ---
    const UI_VERTEX_SHADER = `
        varying vec2 vUv;
        void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }
    `;

    const BUILDING_SHADER = {
        uniforms: { time: { value: 0 } },
        vertexShader: UI_VERTEX_SHADER,
        fragmentShader: `
            varying vec2 vUv;
            uniform float time;
            void main() {
                vec3 base = vec3(0.05, 0.05, 0.1);
                float grid = step(0.1, fract(vUv.x * 5.0)) * step(0.1, fract(vUv.y * 5.0));
                vec3 glow = vec3(0.0, 0.8, 1.0) * (0.5 + 0.5 * sin(time * 2.0));
                gl_FragColor = vec4(mix(glow, base, grid), 1.0);
            }
        `
    };

    // --- Setup ---
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.autoClear = false;
    document.body.appendChild(renderer.domElement);

    const sceneCity = new THREE.Scene();
    sceneCity.fog = new THREE.FogExp2(0x000205, 0.004);
    const cameraCity = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 2000);
    cameraCity.position.set(150, 150, 300);

    const sceneUI = new THREE.Scene();
    const cameraUI = new THREE.OrthographicCamera(window.innerWidth / -2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / -2, 1, 1000);
    cameraUI.position.z = 10;

    // --- Live Construction Logic ---
    const buildingMaterial = new THREE.ShaderMaterial(BUILDING_SHADER);
    const boxGeom = new THREE.BoxGeometry(10, 10, 10);
    const buildings = [];
    let lastBuildTime = 0;

    function createConstructionSite() {
        const x = (Math.random() - 0.5) * CITY_SIZE;
        const z = (Math.random() - 0.5) * CITY_SIZE;
        return {
            basePos: new THREE.Vector3(x, 0, z),
            currentHeight: 0,
            maxHeight: 10 + Math.random() * 20,
            cubes: [],
            isBridging: Math.random() > 0.7
        };
    }

    function updateConstruction(time) {
        if (time - lastBuildTime > CONSTRUCTION_SPEED && buildings.length < MAX_BUILDINGS) {
            buildings.push(createConstructionSite());
            lastBuildTime = time;
        }

        buildings.forEach(b => {
            if (b.currentHeight < b.maxHeight) {
                const mesh = new THREE.Mesh(boxGeom, buildingMaterial);
                mesh.position.set(b.basePos.x, b.currentHeight * 10, b.basePos.z);
                mesh.scale.set(0.1, 0.1, 0.1); // Start small for "grow" effect
                
                sceneCity.add(mesh);
                b.cubes.push(mesh);
                b.currentHeight++;

                // If bridging, add a horizontal connection every 5 floors
                if (b.isBridging && b.currentHeight % 5 === 0) {
                    const bridge = new THREE.Mesh(new THREE.BoxGeometry(40, 2, 5), buildingMaterial);
                    bridge.position.set(b.basePos.x + 20, b.currentHeight * 10, b.basePos.z);
                    sceneCity.add(bridge);
                }
            }

            // Animate building growth
            b.cubes.forEach(c => {
                if (c.scale.x < 1) {
                    c.scale.x += 0.05;
                    c.scale.y += 0.05;
                    c.scale.z += 0.05;
                }
            });
        });
    }

    // --- UI Implementation (Simplified for brevity) ---
    function createButton(text, x, y, onClick) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 256; canvas.height = 64;
        ctx.fillStyle = '#00ffcc'; ctx.font = 'Bold 30px Courier'; ctx.textAlign = 'center';
        ctx.fillText(text, 128, 40);
        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(150, 40), new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true }));
        mesh.position.set(x, y, 0);
        sceneUI.add(mesh);
    }

    createButton("CRIMEWARS ALPHA", 0, 200);
    createButton("REBUILD CITY", 0, -200, () => location.reload());

    // --- Main Loop ---
    function animate(t) {
        requestAnimationFrame(animate);
        const time = t / 1000;

        // Update construction engine
        updateConstruction(time);
        buildingMaterial.uniforms.time.value = time;

        // Camera orbit
        cameraCity.position.x = Math.sin(time * 0.1) * 400;
        cameraCity.position.z = Math.cos(time * 0.1) * 400;
        cameraCity.lookAt(0, 50, 0);

        renderer.clear();
        renderer.render(sceneCity, cameraCity);
        renderer.clearDepth();
        renderer.render(sceneUI, cameraUI);
    }

    animate(0);

    window.addEventListener('resize', () => {
        renderer.setSize(window.innerWidth, window.innerHeight);
        cameraCity.aspect = window.innerWidth / window.innerHeight;
        cameraCity.updateProjectionMatrix();
    });
</script>
</body>
</html>
